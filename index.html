<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>〔特〕抽出ツール（介護経過表）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif; line-height: 1.6; padding: 16px; }
    header { margin-bottom: 12px; }
    .dropzone { border: 2px dashed #7b8; padding: 24px; border-radius: 8px; color: #055; text-align: center; margin: 12px 0; }
    .dropzone.dragover { background: #f0fff7; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 12px 0; }
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; white-space: nowrap; position: sticky; top: 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .small { font-size: 12px; color: #666; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #eef; color: #225; font-size: 12px; margin-left: 6px; }
    .hidden { display: none; }
    footer { margin-top: 24px; color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>〔特〕抽出ツール（介護経過表PDF → CSV）</h1>
    <div class="small">すべてブラウザ内で処理します / PDFテキスト抽出: pdf.js</div>
  </header>

  <div class="controls">
    <input type="file" id="fileInput" accept="application/pdf" multiple />
    <button id="btnSample" type="button">サンプルで試す</button>
    <label><input type="checkbox" id="includeTimeline" /> タイムライン欄の「[特]」も含める</label>
    <button id="btnExport" class="hidden" type="button">CSVをダウンロード</button>
    <span id="status" class="badge">待機中</span>
  </div>

  <div id="dropzone" class="dropzone">PDFファイルをここにドロップするか、上のボタンから選択してください。</div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>ファイル名</th>
        <th>ページ</th>
        <th>氏名</th>
        <th>〔特〕枠の内容</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>
    <p>抽出ルール：行頭が <span class="mono">HH:MM [特]</span> で始まる行（特記事項枠）を対象。必要に応じて調整可能。</p>
  </footer>

  <!-- pdf.js（UMD版） -->
  <ttps://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js</script>
  <script>
    // ワーカーの場所を指定（同じCDN）
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const tbody = document.querySelector('#resultTable tbody');
    const btnExport = document.getElementById('btnExport');
    const btnSample = document.getElementById('btnSample');
    const statusBadge = document.getElementById('status');
    const includeTimeline = document.getElementById('includeTimeline');

    const results = []; // {file,page,name,tokki}

    function setStatus(text) { statusBadge.textContent = text; }

    // 文字列正規化（全角空白→半角、連続空白の圧縮など）
    function normalize(s) {
      return s.replace(/\u3000/g, ' ').replace(/[ \t\r]+/g, ' ').trim();
    }

    // ページの textContent から「行」を復元
    async function pageToLines(page) {
      const tc = await page.getTextContent({ normalizeWhitespace: false, disableCombineTextItems: false });
      const items = tc.items || [];

      // 1) hasEOL を優先して改行復元
      const lines = [];
      let cur = [];
      for (const it of items) {
        cur.push(it.str);
        if (it.hasEOL) {
          lines.push(cur.join(''));
          cur = [];
        }
      }
      if (cur.length) lines.push(cur.join(''));

      // 2) 後処理：行内のレイアウト空白を少し整える
      return lines.map(l => l.replace(/[ \t]+/g, ' ').trim()).filter(l => l.length);
    }

    // 氏名の抽出（ご利用者名 ... 来所日時 の間）
    function extractName(pageText) {
      // Unicode プロパティで日本語の氏名に幅を持たせる
      const re = /ご利用者名\s*([\p{sc=Hani}\p{sc=Hira}\p{sc=Kana}ー・\s]+?)\s+来所日時/iu;
      const m = pageText.replace(/\s+/g, ' ').match(re);
      return m ? m[1].trim() : '';
    }

    // 〔特〕枠の抽出
    function extractTokkiLines(lines, includeTimelineMode = false) {
      const tokki = [];
      const reFrame = /^(\d{2}:\d{2})\s*[\[\(（]?特[\]\)）]?\s*(.+)$/u;
      const reAny = includeTimelineMode
        ? /特/ // ざっくり（任意の「特」を含む行）
        : reFrame;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        if (!includeTimelineMode) {
          const m = line.match(reFrame);
          if (m) {
            // 連結（次行がインデント風・時刻非開始なら続きとみなす）
            let content = m[2];
            let j = i + 1;
            while (j < lines.length && !/^\d{2}:\d{2}\b/.test(lines[j]) && !/^\s*$/.test(lines[j])) {
              content += ' ' + lines[j].trim();
              j++;
            }
            i = j - 1;
            tokki.push(`${m[1]} ${content}`.replace(/[ \t]+/g, ' ').trim());
          }
        } else {
          // タイムラインも含めて「特」を含む行を採用（必要に応じて厳格化可能）
          if (reAny.test(line)) tokki.push(line);
        }
      }
      return tokki;
    }

    // CSV生成
    function toCSV(rows) {
      const header = ['ファイル名','ページ','氏名','〔特〕枠の内容'];
      const esc = v => {
        const s = String(v ?? '').replace(/"/g, '""').replace(/\r?\n/g, '\\n');
        return `"${s}"`;
      };
      const body = rows.map(r => [r.file, r.page, r.name, r.tokki.join('\\n')].map(esc).join(','));
      return [header.join(','), ...body].join('\n');
    }

    function renderRows(rows) {
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        const tdFile = document.createElement('td'); tdFile.textContent = r.file;
        const tdPage = document.createElement('td'); tdPage.textContent = r.page;
        const tdName = document.createElement('td'); tdName.textContent = r.name;
        const tdTok = document.createElement('td'); tdTok.innerHTML = r.tokki.map(l => `<div>${l.replace(/</g,'&lt;')}</div>`).join('');
        tr.append(tdFile, tdPage, tdName, tdTok);
        tbody.appendChild(tr);
      }
      btnExport.classList.toggle('hidden', rows.length === 0);
    }

    async function handleFiles(fileList) {
      setStatus('解析中…');
      results.length = 0;
      renderRows(results);

      for (const file of fileList) {
        const ab = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const lines = await pageToLines(page);
          const pageText = lines.join('\n');

          const name = extractName(pageText);
          const tokki = extractTokkiLines(lines, includeTimeline.checked);

          if (tokki.length > 0) {
            results.push({ file: file.name, page: p, name: name, tokki });
          }
        }
      }
      renderRows(results);
      setStatus(`完了：${results.length} 行`);
    }

    // ドラッグ＆ドロップ
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', e => {
      e.preventDefault(); dropzone.classList.remove('dragover');
      if (e.dataTransfer?.files?.length) handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', e => {
      if (fileInput.files?.length) handleFiles(fileInput.files);
    });

    // CSVダウンロード
    btnExport.addEventListener('click', () => {
      const csv = toCSV(results);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dt = new Date();
      const ts = dt.toISOString().slice(0,19).replace(/[:T]/g,'');
      a.href = url;
      a.download = `tokki_extract_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    });

    // サンプル（ダミー1ページ相当のテキストをpdf風に解析する代わりのデモ）
    btnSample.addEventListener('click', async () => {
      const sampleLines = [
        '介護経過表 ご利用者名 佐竹 純子 来所日時 2025年10月01日 09:13',
        '09:17 [特] バイタルチェック P47回／分(整)胸部症状なし(鷹取)',
        'その他の行'
      ];
      results.length = 0;
      results.push({ file: 'sample.pdf', page: 1, name: extractName(sampleLines.join(' ')), tokki: extractTokkiLines(sampleLines) });
      renderRows(results);
      btnExport.classList.toggle('hidden', results.length === 0);
      setStatus('サンプル抽出完了');
    });
  </script>
</body>
</html>
